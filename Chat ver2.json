var ss = SpreadsheetApp.openByUrl("https://docs.google.com/spreadsheets/d/104Hp8VjSYv7ilMI-3D8ZwrL65FIl4gnMqmp8dXN3zWk/edit?usp=sharing");
var sheet = ss.getSheetByName("Inventory");
var sheet2 = ss.getSheetByName("Equip Log");
var sheet3 = ss.getSheetByName("Room Log");

function doPost(e) {
  var data = JSON.parse(e.postData.contents);
  var userMsg = data.originalDetectIntentRequest.payload.data.message.text;
  
  var values = sheet.getRange(2, 1, sheet.getLastRow(), sheet.getLastColumn()).getValues();
  var values2 = sheet2.getRange(2, 1, sheet2.getLastRow(), sheet2.getLastColumn()).getValues();
  var values3 = sheet3.getRange(2, 1, sheet3.getLastRow(), sheet3.getLastColumn()).getValues();

  var command = userMsg.split(',');
  var now = new Date();
  var timestamp = Utilities.formatDate(now, "GMT+7", "dd/MM/yyyy HH:mm:ss");

  // Condition 00 - Carousel Menu
  if (command[0] == "Start") {
    return Result0(); 
  } 

  // Condition 01 - Check Equipment
  else if (command[0] == "Check") {
    for (var i = 0; i < values.length; i++) {
      if (values[i][0] == command[1]) {
        var rowIdx = i + 2;
        var Data = sheet.getRange(rowIdx, 2).getValue();
        var Pic = sheet.getRange(rowIdx, 6).getValue();
        var Current = sheet.getRange(rowIdx, 5).getValue();
        return Result2(Pic, Data, Current);
      }
    }
  }

  // Condition 02 - Book Equipment
  else if (command[0] == "Ebook") {
    for (var i = 0; i < values.length; i++) {
      if (values[i][0] == command[1]) {
        var rowIdx = i + 2;
        var Data = sheet.getRange(rowIdx, 2).getValue();
        var Left = sheet.getRange(rowIdx, 5).getValue();
        var Current = parseInt(Left) - parseInt(command[2]);
        sheet.getRange(rowIdx, 5).setValue(Current);
        sheet2.appendRow([command[3], command[1], command[2], timestamp, "Book"]);
        return Result1(Data, Current);
      }
    }
  }

  // Condition 03 - Return Equipment
  else if (command[0] == "Ereturn") {
    for (var i = 0; i < values.length; i++) {
      if (values[i][0] == command[1]) {
        var rowIdx = i + 2;
        var Data = sheet.getRange(rowIdx, 2).getValue();
        var Left = sheet.getRange(rowIdx, 5).getValue();
        var Current = parseInt(Left) + parseInt(command[2]);
        sheet.getRange(rowIdx, 5).setValue(Current);
        sheet2.appendRow([command[3], command[1], command[2], timestamp, "Return"]);
        return Result1(Data, Current);
      }
    }
  }

  // Condition 04/05 - Room Management
  else if (command[0] == "Rbook" || command[0] == "Rreturn") {
    var isBooking = (command[0] == "Rbook");
    for (var i = 0; i < values.length; i++) {
      if (values[i][0] == command[1]) {
        var rowIdx = i + 2;
        var Data = sheet.getRange(rowIdx, 2).getValue();
        var status = isBooking ? "Occupied" : "Unoccupied";
        var logAction = isBooking ? "Enter" : "Leave";
        
        sheet3.appendRow([command[2], command[1], timestamp, logAction]);
        sheet.getRange(rowIdx, 5).setValue(status);
        return Result1(Data, status);
      }
    }
  }

  // Condition 06 - Logs
  else if (command[0] == "Elog" || command[0] == "Rlog") {
    var userToFind = command[1];
    var targetValues = (command[0] == "Elog") ? values2 : values3;
    var summary = "Logs for " + userToFind + ":\n";
    var found = false;

    for (var i = 0; i < targetValues.length; i++) {
      if (targetValues[i][0] == userToFind) {
        summary += "- " + targetValues[i][3] + ": " + targetValues[i][4] + " " + (targetValues[i][2] || "") + " " + targetValues[i][1] + "\n";
        found = true;
      }
    }
    return Result3(found ? summary : "No logs found for: " + userToFind);
  }
}

// ------------------- UI FUNCTIONS -------------------

function Result0() {
  var carouselPayload = {
    "type": "template",
    "altText": "Inventory Management Menu",
    "template": {
      "type": "carousel",
      "columns": [
        {
          "thumbnailImageUrl": "https://images.unsplash.com/photo-1531482615713-2afd69097998?w=500",
          "title": "Equipment",
          "text": "Manage your inventory items",
          "actions": [
            { "type": "message", "label": "Check Item", "text": "Check,ID" },
            { "type": "message", "label": "Borrow Item", "text": "Ebook,ID,QTY,USER" }
          ]
        },
        {
          "thumbnailImageUrl": "https://images.unsplash.com/photo-1497366216548-37526070297c?w=500",
          "title": "Room Booking",
          "text": "Reserve or release rooms",
          "actions": [
            { "type": "message", "label": "Book Room", "text": "Rbook,ROOM_ID,USER" },
            { "type": "message", "label": "Return Room", "text": "Rreturn,ROOM_ID,USER" }
          ]
        },
        {
          "thumbnailImageUrl": "https://images.unsplash.com/photo-1450101499163-c8848c66ca85?w=500",
          "title": "Activity Logs",
          "text": "Check your transaction history",
          "actions": [
            { "type": "message", "label": "Equip Logs", "text": "Elog,USER_ID" },
            { "type": "message", "label": "Room Logs", "text": "Rlog,USER_ID" }
          ]
        }
      ]
    }
  };

  return buildReply(carouselPayload);
}

function Result1(Data, Current) {
  return buildReply({ "type": "text", "text": "âœ… UPDATE SUCCESS\nITEM: " + Data + "\nSTATUS: " + Current });
}

function Result2(Pic, Data, Current) {
  var flex = {
    "type": "flex",
    "altText": "Item Status",
    "contents": {
      "type": "bubble",
      "hero": { "type": "image", "url": Pic, "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" },
      "body": {
        "type": "box", "layout": "vertical", "contents": [
          { "type": "text", "text": Data, "weight": "bold", "size": "xl" },
          { "type": "box", "layout": "baseline", "margin": "md", "contents": [
            { "type": "text", "text": "Status: ", "color": "#aaaaaa", "size": "sm" },
            { "type": "text", "text": String(Current), "color": "#666666", "size": "sm" }
          ]}
        ]
      }
    }
  };
  return buildReply(flex);
}

function Result3(summary) {
  return buildReply({ "type": "text", "text": summary });
}

// Helper to wrap Line Payload for Dialogflow
function buildReply(linePayload) {
  var result = {
    "fulfillmentMessages": [{
      "platform": "line",
      "type": 4,
      "payload": { "line": linePayload }
    }]
  };
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}
