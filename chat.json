var ss = SpreadsheetApp.openByUrl("https://docs.google.com/spreadsheets/d/104Hp8VjSYv7ilMI-3D8ZwrL65FIl4gnMqmp8dXN3zWk/edit?usp=sharing");
var sheet = ss.getSheetByName("STOCK");
function doPost(e) {
  var data = JSON.parse(e.postData.contents);
  var userMsg = data.originalDetectIntentRequest.payload.data.message.text;
  var values = sheet.getRange(2, 1, sheet.getLastRow(), sheet.getLastColumn()).getValues();
  var command = userMsg.split(',');

  if (command[0] == "add"){
  for (var i = 0; i < values.length; i++) {
    if (values[i][0] == command[1]) {
      i = i + 2;
      var Data = sheet.getRange(i, 2).getValue();
      var Pic = sheet.getRange(i,6).getValue();
      var Price = sheet.getRange(i,3).getValue();
      var Left = sheet.getRange(i,5).getValue();
      var Current  = parseInt(Left) + parseInt(command[2]);
      sheet.getRange(i,5).setValue(Current ).toString();
      }
    } 
  } else if (command[0] == "remove"){
  for (var i = 0; i < values.length; i++) {
    if (values[i][0] == command[1]) {
      i = i + 2;
      var Data = sheet.getRange(i, 2).getValue();
      var Pic = sheet.getRange(i,6).getValue();
      var Price = sheet.getRange(i,3).getValue();
      var Left = sheet.getRange(i,5).getValue();
      var Current = parseInt(Left) - parseInt(command[2]);
      sheet.getRange(i,5).setValue(Current).toString();
      }
    }
  }
  return Result(Pic,Data,Current,Price);
}  

var Pic,Data,Current,Price
function Result(Pic,Data,Current,Price){
  var result = {
  "fulfillmentMessages": [
      {
          "platform": "line",
          "type": 4,
          "payload": {
              "line": {
                "type": "flex",
                "altText":"flex message",
                "contents": {
                  "type": "bubble",
                  "hero": {
                    "type": "image",
                    "url": Pic,
                    "size": "full",
                    "aspectRatio": "20:13",
                    "aspectMode": "cover",
                    "action": {
                      "type": "uri",
                      "label": "Line",
                      "uri": "https://linecorp.com/"
                    }
                  },
                  "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      {
                        "type": "text",
                        "text": Data,
                        "weight": "bold",
                        "size": "xl",
                        "contents": []
                      },
                      {
                        "type": "box",
                        "layout": "baseline",
                        "margin": "md",
                        "contents": [
                          {
                            "type": "icon",
                            "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png",
                            "size": "sm"
                          },
                          {
                            "type": "icon",
                            "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png",
                            "size": "sm"
                          },
                          {
                            "type": "icon",
                            "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png",
                            "size": "sm"
                          },
                          {
                            "type": "icon",
                            "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png",
                            "size": "sm"
                          },
                          {
                            "type": "icon",
                            "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gray_star_28.png",
                            "size": "sm"
                          },
                          {
                            "type": "text",
                            "text": "4.0",
                            "size": "sm",
                            "color": "#999999",
                        
                            "margin": "md",
                            "contents": []
                          }
                        ]
                      },
                      {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "sm",
                        "margin": "lg",
                        "contents": [
                          {
                            "type": "box",
                            "layout": "baseline",
                            "spacing": "sm",
                            "contents": [
                              {
                                "type": "text",
                                "text": "left over: ",
                                "size": "sm",
                                "color": "#AAAAAA",
                            
                                "contents": []
                              },
                              {
                                "type": "text",
                                "text": String(Current),
                                "size": "sm",
                                "color": "#666666",
                          
                                "wrap": true,
                                "contents": []
                              }
                            ]
                          },
                          {
                            "type": "box",
                            "layout": "baseline",
                            "spacing": "sm",
                            "contents": [
                              {
                                "type": "text",
                                "text": "Price",
                                "size": "sm",
                                "color": "#AAAAAA",
                              
                                "contents": []
                              },
                              {
                                "type": "text",
                                "text": String(Price),
                                "size": "sm",
                                "color": "#666666",
                          
                                "wrap": true,
                                "contents": []
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  "footer": {
                    "type": "box",
                    "layout": "vertical",

                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "button",
                        "action": {
                          "type": "uri",
                          "label": "CALL",
                          "uri": "https://linecorp.com"
                        },
                        "height": "sm",
                        "style": "link"
                      },
                      {
                        "type": "button",
                        "action": {
                          "type": "uri",
                          "label": "WEBSITE",
                          "uri": "https://linecorp.com"
                        },
                        "height": "sm",
                        "style": "link"
                      },
                      {
                        "type": "spacer",
                        "size": "sm"
                      }
                    ]
                  }
                }
              

          }
        }
      }
    ]
  }
  var replyJSON = ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  return replyJSON;
}




